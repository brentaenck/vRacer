<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drag Test</title>
    <style>
        canvas {
            border: 1px solid #ccc;
            cursor: default;
        }
        .debug {
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Simple Drag Test</h1>
    <canvas id="testCanvas" width="800" height="600"></canvas>
    
    <div class="debug">
        <div>Mouse: <span id="mousePos">-</span></div>
        <div>Dragging: <span id="dragState">false</span></div>
        <div>Selected: <span id="selectedPoint">none</span></div>
    </div>

    <script>
        const canvas = document.getElementById('testCanvas');
        const ctx = canvas.getContext('2d');
        
        // Simple test points
        const points = [
            { x: 100, y: 100, color: 'red' },
            { x: 200, y: 150, color: 'blue' },
            { x: 300, y: 200, color: 'green' }
        ];
        
        let isDragging = false;
        let selectedIndex = null;
        let dragOffset = { x: 0, y: 0 };
        
        function getMousePos(event) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            };
        }
        
        function findNearestPoint(mousePos) {
            for (let i = 0; i < points.length; i++) {
                const dx = mousePos.x - points[i].x;
                const dy = mousePos.y - points[i].y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                if (distance < 20) return i;
            }
            return null;
        }
        
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            points.forEach((point, index) => {
                ctx.beginPath();
                ctx.arc(point.x, point.y, index === selectedIndex ? 15 : 10, 0, 2 * Math.PI);
                ctx.fillStyle = point.color;
                ctx.fill();
                
                if (index === selectedIndex) {
                    ctx.strokeStyle = 'gold';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
            });
        }
        
        function updateDebug(mousePos) {
            document.getElementById('mousePos').textContent = `${mousePos.x.toFixed(0)}, ${mousePos.y.toFixed(0)}`;
            document.getElementById('dragState').textContent = isDragging;
            document.getElementById('selectedPoint').textContent = selectedIndex !== null ? selectedIndex : 'none';
        }
        
        canvas.addEventListener('mousedown', (event) => {
            const mousePos = getMousePos(event);
            const nearest = findNearestPoint(mousePos);
            console.log('Mouse down at:', mousePos, 'Nearest:', nearest);
            
            if (nearest !== null) {
                selectedIndex = nearest;
                isDragging = true;
                dragOffset.x = mousePos.x - points[nearest].x;
                dragOffset.y = mousePos.y - points[nearest].y;
                canvas.style.cursor = 'grabbing';
                console.log('Started dragging point', nearest, 'offset:', dragOffset);
            } else {
                selectedIndex = null;
            }
            
            draw();
            updateDebug(mousePos);
        });
        
        canvas.addEventListener('mousemove', (event) => {
            const mousePos = getMousePos(event);
            updateDebug(mousePos);
            
            if (isDragging && selectedIndex !== null) {
                console.log('Dragging to:', mousePos);
                points[selectedIndex].x = mousePos.x - dragOffset.x;
                points[selectedIndex].y = mousePos.y - dragOffset.y;
                draw();
            } else {
                const nearest = findNearestPoint(mousePos);
                canvas.style.cursor = nearest !== null ? 'grab' : 'default';
            }
        });
        
        canvas.addEventListener('mouseup', (event) => {
            if (isDragging) {
                console.log('Mouse up - stopping drag');
                isDragging = false;
                canvas.style.cursor = 'grab';
            }
        });
        
        canvas.addEventListener('mouseleave', (event) => {
            isDragging = false;
            canvas.style.cursor = 'default';
        });
        
        // Initial draw
        draw();
        console.log('Drag test initialized');
    </script>
</body>
</html>
